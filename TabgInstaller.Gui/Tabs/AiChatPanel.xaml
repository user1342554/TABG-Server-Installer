<UserControl x:Class="TabgInstaller.Gui.Tabs.AiChatPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:TabgInstaller.Gui.Converters">
    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    </UserControl.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="100"/>
        </Grid.RowDefinitions>

        <!-- Status Bar -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="5" VerticalAlignment="Center">
            <Label Content="Status:"/>
            <TextBlock Name="StatusText" Text="Setup required" VerticalAlignment="Center" Margin="5,0"/>
            <Label Content="Model:" Margin="20,0,0,0"/>
            <TextBlock Name="ModelNameText" Text="—" VerticalAlignment="Center" Margin="5,0"/>
            <Label Content="Mode:" Margin="20,0,0,0"/>
            <TextBlock Name="ModeText" Text="—" VerticalAlignment="Center" Margin="5,0"/>

            <Label Content="Chat:" Margin="20,0,0,0"/>
            <ComboBox Name="HistoryComboBox" Width="220" SelectionChanged="HistoryComboBox_SelectionChanged"/>
            <Button Content="New" Margin="5,0,0,0" Click="NewChat_Click"/>

            <Button Content="Clear Chat" Margin="20,0,5,0" Click="ClearChat_Click"/>
            <Button Content="Settings" Click="Settings_Click"/>
        </StackPanel>

        <!-- Chat Messages -->
        <ScrollViewer Grid.Row="1" Name="ChatScrollViewer" VerticalScrollBarVisibility="Auto" ScrollChanged="ChatScrollViewer_ScrollChanged">
            <ListBox Name="ChatMessages" ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Border Margin="5" Padding="10" BorderThickness="1" BorderBrush="LightGray">
                            <StackPanel>
                                <TextBlock Text="{Binding Role}" FontWeight="Bold"/>
                                <TextBlock Text="{Binding Content}" TextWrapping="Wrap" Margin="0,5,0,0"/>
                                <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                                    <TextBlock Text="{Binding Timestamp}" FontSize="10" Foreground="Gray"/>
                                    <Button Content="Edit" Visibility="{Binding ShowEditButton, Converter={StaticResource BoolToVisibilityConverter}}"
                                            Tag="{Binding}" Click="EditMessage_Click" Margin="10,0,0,0" Padding="5,2"/>
                                    <Button Content="Reload" Visibility="{Binding ShowReloadButton, Converter={StaticResource BoolToVisibilityConverter}}"
                                            Tag="{Binding}" Click="ReloadMessage_Click" Margin="10,0,0,0" Padding="5,2"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </ScrollViewer>

        <!-- Input Area -->
        <Grid Grid.Row="2" Margin="5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBox Name="UserInput" Grid.Column="0" TextWrapping="Wrap" AcceptsReturn="True" 
                     VerticalScrollBarVisibility="Auto" KeyDown="UserInput_KeyDown"/>
            <Button Name="SendButton" Grid.Column="1" Content="Send" Width="80" Height="40" 
                    Margin="5,0,0,0" Click="SendButton_Click"/>
        </Grid>

        <!-- Typing Indicator -->
        <TextBlock Name="TypingIndicator" Grid.Row="1" Text="AI is typing..." 
                   HorizontalAlignment="Center" VerticalAlignment="Bottom" 
                   Visibility="Collapsed" Margin="0,0,0,10"/>

        <!-- Setup Overlay -->
        <Grid Name="SetupOverlay" Grid.RowSpan="3" Background="#F0F0F0" Visibility="Visible">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Width="600">
                <TextBlock Text="AI Setup" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center" Margin="0,0,0,20"/>
                
                <!-- Selection Panel -->
                <StackPanel Name="SelectionPanel">
                    <Button Content="Use Local AI" Height="50" Margin="5" Click="LocalOption_Click"/>
                    <Button Content="Use Online AI" Height="50" Margin="5" Click="OnlineOption_Click"/>
                </StackPanel>

                <!-- Local Download Panel -->
                <StackPanel Name="LocalDownloadPanel" Visibility="Collapsed">
                    <Label Content="Model Directory:"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Name="ModelDirectoryTextBox" Grid.Column="0" Margin="5"/>
                        <Button Content="Browse" Grid.Column="1" Width="80" Margin="5" Click="BrowseDirectory_Click"/>
                    </Grid>
                    <TextBlock Name="SpaceInfoText" Margin="5"/>
                    
                    <Label Content="Available Models:" Margin="0,10,0,0"/>
                    <ListBox Name="ModelsList" Height="200" SelectionMode="Multiple">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <CheckBox IsChecked="{Binding IsSelected}" Content="{Binding DisplayName}"/>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,10,0,0">
                        <Button Name="DownloadButton" Content="Download Selected" Width="150" Margin="5" Click="StartDownload_Click"/>
                        <Button Content="Use Installed Model" Width="150" Margin="5" Click="UseInstalledModel_Click"/>
                        <Button Content="Back" Width="80" Margin="5" Click="Back_Click"/>
                    </StackPanel>
                </StackPanel>

                <!-- Online Setup Panel -->
                <StackPanel Name="OnlineSetupPanel" Visibility="Collapsed">
                    <Label Content="Select Provider:"/>
                    <ComboBox Name="ProviderComboBox" Margin="5" SelectionChanged="ProviderComboBox_SelectionChanged"/>

                    <Label Content="Select Model:"/>
                    <ComboBox Name="OnlineModelComboBox" Margin="5"/>
                    
                    <Label Content="API Key:"/>
                    <PasswordBox Name="ApiKeyBox" Margin="5" PasswordChanged="ApiKeyBox_PasswordChanged"/>
                    <TextBlock Name="HelpText" Margin="5" TextWrapping="Wrap"/>
                    <TextBlock Name="ValidationMessage" Margin="5" Visibility="Collapsed"/>
                    
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,10,0,0">
                        <Button Name="SaveApiKeyButton" Content="Connect" Width="150" Margin="5" Click="SaveApiKey_Click" IsEnabled="False"/>
                        <Button Content="Back" Width="80" Margin="5" Click="Back_Click"/>
                    </StackPanel>
                </StackPanel>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>